##  natural language usage

 - 日本語で回答してください
 - ソースコード中のコメントは日本語

# TLG8 encoder project

## about building

 - ビルドコマンドは `mkdir -p build && cmake --build build`


## about encoder round-trip testing

 - テスト画像に対してエンコード→デコードを行い、元の画像と一致するか(一致すれば成功)をテストするラウンドトリップテストは → `python test/run_roundtrip.py --tlgconv build/tlgconv --images test/images`  このテストは数分かかります。気長に待ってね。


# TLG8 Machine Learning Design Intent

## 1. この機械学習の目的（最重要）

TLG8 における機械学習の目的は、

**圧縮率を最大化することそのものではない。**
**また、ニューラルネットワーク単体の推論精度（top-1 accuracy）を最大化することでもない。**

この機械学習の唯一の目的は：

> **TLG8 のエンコード時に必要な「パラメータ総当たり試行数」を削減し、  
> トータルのエンコード時間を短縮すること**

である。

---

## 2. 基本方針（重要な判断軸）

### 2.1 許容されるトレードオフ

以下は **明確に許容される**：

- 前処理（C++ エクストラクター）が多少重くなること  
  **ただし** それによって：
  - NN の推論精度（特に top-N）が向上し
  - 試行すべきエンコードパラメータ数が減り
  - 結果として **全体のエンコード時間が短縮される場合**

このプロジェクトでは、

> **「前処理が重い = 悪」ではない**  
> **「トータルで速くなる = 勝ち」**

という評価基準を採用する。

---

### 2.2 NN の役割

ニューラルネットワークは：

- 「最適な圧縮結果を直接出力する存在」ではない
- 「エンコードパラメータ空間を探索するためのガイド」である

具体的には：

- 入力：8×8 ブロック由来の特徴量
- 出力：  
  - reorder などの **エンコードパラメータ候補の順位（ランキング）**
- 利用方法：
  - 上位 N 個のみを実際の TLG8 エンコードで試す

したがって、

- **top-3 / top-5 精度が top-1 より重要**
- 「ほぼ正解に近い候補を早く出す」ことが最優先

---

## 3. ラベル生成と特徴量生成の分離（設計上の重要点）

### 3.1 ラベル（正解）の性質

- ラベルは「現状の TLG8 実装」に基づく
- 各ブロックについて：
  - 全エンコードパラメータを総当たり
  - 最も圧縮結果が良いパラメータを正解ラベルとする
- この処理は **極めて計算コストが高い**

### 3.2 特徴量の性質

- 特徴量は主に：
  - 8×8 ピクセルブロック
  - その統計量・周波数特性・エッジ特性など
- ラベル生成と比べて **計算コストは低い**
- 特徴設計は頻繁に変更・実験される

### 3.3 設計方針

そのため、

- **labels と features は完全に独立して生成できる設計とする**
- 同一ブロックに対して：
  - 重い label 生成は「なるべく一度だけ」
  - 軽い feature 生成は「何度でも作り直せる」

この分離は **最適化・実験速度・コード理解性** のために必須である。

---

## 4. エクストラクター設計に関する指針

### 4.1 C++ エクストラクターの役割

- 数千〜数万枚の画像
- 数百万〜数千万ブロック
を扱うため、エクストラクターは **C++ 実装を前提**とする。

### 4.2 特徴量の段階的設計（Tier 概念）

特徴量は計算コストに応じて段階化する：

- Tier0：  
  - 極めて軽量（平均・分散・簡単な差分など）
- Tier1：  
  - 中程度（8×8 DCT など）
- Tier2：  
  - 重いが精度向上が期待できる（簡易エンコード結果など）

どの Tier を使うかは **実験で決める**。  
設計段階で「重いから却下」はしない。

---

## 5. 機械学習コードに対する姿勢（重要）

このプロジェクトでは：

- 実装速度のために Codex / LLM を利用することを許可する
- しかし：
  - **コードの意味を作者自身が理解できること**
  - **後から読み直して追跡できること**
を最優先とする

そのため、

- 複雑な抽象化
- 過度な自動生成コード
- 意図が読み取れないトリック

は避ける。

**「少し遅くても、読めるコード」**  
**「1年後の自分が理解できる設計」**  
をこのリポジトリの原則とする。

---

## 6. 成功の定義

この機械学習が成功したと言える条件は：

- NN の精度指標が改善したことではなく
- **TLG8 エンコード全体の wall-clock time が短縮されたこと**

である。

モデル・特徴量・損失関数・前処理は、
この目的に資する限りにおいてのみ評価される。
